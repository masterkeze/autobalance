## å‰è¨€



## èƒŒæ™¯çŸ¥è¯†

### ä»€ä¹ˆæ˜¯å¼‚æ­¥

ä¸¾ä¸ªç®€å•çš„[ä¾‹å­](https://docs.microsoft.com/zh-cn/dotnet/csharp/programming-guide/concepts/async/)ï¼Œåšæ—©é¤éœ€è¦ä¸‹é¢è¿™äº›æ­¥éª¤ï¼š

1. å€’ä¸€æ¯å’–å•¡ã€‚
2. åŠ çƒ­å¹³åº•é”…ï¼Œç„¶åç…ä¸¤ä¸ªé¸¡è›‹ã€‚
3. ç…ä¸‰ç‰‡åŸ¹æ ¹ã€‚
4. çƒ¤ä¸¤ç‰‡é¢åŒ…ã€‚
5. åœ¨çƒ¤é¢åŒ…ä¸ŠåŠ é»„æ²¹å’Œæœé…±ã€‚
6. å€’ä¸€æ¯æ©™æ±ã€‚

å¦‚æœæŒ‰é¡ºåºä¸€é¡¹é¡¹å¤„ç†ï¼Œä½ å¯èƒ½è¦èŠ±è´¹30åˆ†é’Ÿã€‚

![åŒæ­¥æ—©é¤](https://upload-images.jianshu.io/upload_images/26257383-9721536970062aba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä½†æ˜¯ä¸éš¾æ³¨æ„åˆ°ï¼Œæœ‰ä¸€äº›å·¥ä½œå¼€å§‹åï¼Œä½ å¹¶ä¸éœ€è¦å‘†åœ¨è¾¹ä¸Šå¹²é¢„ï¼Œè€Œæ˜¯å¯ä»¥åŒæ—¶å±•å¼€å…¶ä»–å·¥ä½œï¼Œè¿™å°±æ˜¯å¼‚æ­¥æ‰§è¡Œã€‚

![å¼‚æ­¥æ—©é¤](https://upload-images.jianshu.io/upload_images/26257383-5fdc76e12f2bfa71.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å¼‚æ­¥æ‰§è¡Œï¼Œå¯ä»¥è®©ä¸€äº›æ²¡æœ‰ä¾èµ–å…³ç³»çš„å·¥ä½œ**åŒæ—¶**è¿›è¡Œï¼Œè®©æœ‰ä¾èµ–å…³ç³»çš„å·¥ä½œ**æŒ‰é¡ºåº**æ‰§è¡Œï¼Œä»è€Œå‡å°‘æ•´ä¸ªè¿‡ç¨‹çš„è€—æ—¶ã€‚

### Screepsä¸­çš„è®¾è®¡æ¨¡å¼

#### è§’è‰²+çŠ¶æ€æœº

[Screeps]([Screeps Documentation](https://docs.screeps.com/api/#Creep))åªæä¾›äº†å¯¹è±¡çš„åŒæ­¥æ–¹æ³•ï¼Œæ¸¸æˆæœ¬èº«åˆæ˜¯è½®è¯¢çš„ç»“æ„ï¼Œå³æ¯ä¸ªtickè°ƒç”¨ä¸€æ¬¡loop()ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå®‰æ’æ¸¸æˆå¯¹è±¡è¿›è¡Œä¸€äº›â€œæŠ½è±¡â€çš„æ“ä½œï¼Œå¾€å¾€é€šè¿‡**è§’è‰²+çŠ¶æ€æœº**æ¥å®ç°ï¼Œæ¯”å¦‚å®˜æ–¹æ•™ç¨‹ä¸­ä½¿ç”¨åˆ°çš„å»ºé€ è€…ä»£ç ï¼š

```javascript
var roleBuilder = {
    /** @param {Creep} creep **/
    run: function(creep) {
	    if(creep.memory.building && creep.store[RESOURCE_ENERGY] == 0) {
            creep.memory.building = false;
            creep.say('ğŸ”„ harvest');
	    }
	    if(!creep.memory.building && creep.store.getFreeCapacity() == 0) {
	        creep.memory.building = true;
	        creep.say('ğŸš§ build');
	    }
	    if(creep.memory.building) {
	        var targets = creep.room.find(FIND_CONSTRUCTION_SITES);
            if(targets.length) {
                if(creep.build(targets[0]) == ERR_NOT_IN_RANGE) {
                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});
                }
            }
	    }
	    else {
	        var sources = creep.room.find(FIND_SOURCES);
            if(creep.harvest(sources[0]) == ERR_NOT_IN_RANGE) {
                creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});
            }
	    }
	}
};
```

**è§’è‰²+çŠ¶æ€æœº**æœ‰ä¸å°‘å±€é™æ€§ï¼ˆä¸¥é‡ç¨‹åº¦ä»ä½åˆ°é«˜ï¼‰ï¼š

1. çŠ¶æ€çš„æ•°é‡å¯èƒ½å¾ˆå¤š
2. ç›´æ¥è°ƒç”¨æ¸¸æˆapiï¼Œé¢—ç²’åº¦ç»†ï¼Œä¹¦å†™ç¹çï¼Œä¸”ä¸å¥½åšå…¨å±€æ§åˆ¶
3. è§’è‰²ä¸€ç»è®¾å®šå‡ ä¹ä¸ä¼šæ›´æ”¹ï¼Œå¾ˆå°‘è¿›è¡Œè§’è‰²é—´çš„èµ„æºè°ƒåº¦
4. å•tickä¸‹ï¼ŒçŠ¶æ€ä¸€èˆ¬åªèƒ½åˆ‡æ¢**æœ‰é™**æ¬¡æ•°
5. çŠ¶æ€ä¸è§’è‰²ä¹‹é—´é«˜åº¦è€¦åˆï¼Œéš¾ä»¥å¤ç”¨

ç¬”è€…åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½ä½¿ç”¨äº†è¿™ç§æ¨¡å¼ã€‚å‰ä¸‰ç‚¹ï¼Œå¯ä»¥é€šè¿‡åˆç†çš„èŒè´£åˆ’åˆ†ï¼Œæ–¹æ³•å…¬ç”¨ç­‰æ¥ç¼“è§£ï¼ŒçœŸæ­£è®©æˆ‘æ”¾å¼ƒè¿™ç§æ¨¡å¼çš„ï¼Œæ˜¯ç¬¬å››ç‚¹å’Œç¬¬äº”ç‚¹ã€‚

#### ä»»åŠ¡ä¸ä»»åŠ¡åˆ¶

åœ¨ç©å®¶ç¤¾ç¾¤é‡Œï¼Œå¸¸å¸¸ä¼šå¬åˆ°ç©å®¶è®¨è®ºâ€œä»»åŠ¡åˆ¶â€ï¼Œä½†æ˜¯å¯¹ä»»åŠ¡åˆ¶çš„ç†è§£æ˜¯å„ä¸ç›¸åŒçš„ï¼Œç¬”è€…åœ¨è¿™é‡Œå…ˆè°ˆè°ˆæˆ‘å¯¹ä»»åŠ¡åˆ¶çš„ç†è§£ã€‚

ä»»åŠ¡æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

1. ä»»åŠ¡çš„æ‰§è¡Œå¾€å¾€æ˜¯è·¨tickçš„
2. ä»»åŠ¡åº”è¯¥åœ¨æœ‰é™çš„æ—¶é—´å†…æ‰§è¡Œå®Œï¼Œå› æ­¤ä»»åŠ¡åº”å½“ç”±æœ‰é™çš„æ­¥éª¤ç»„æˆ
3. æ­¥éª¤çš„æ‰§è¡Œå¾€å¾€ä¹Ÿæ˜¯è·¨tickçš„
4. ä»»åŠ¡çš„æ‰§è¡Œéœ€è¦èµ„æºï¼ˆcreepï¼Œèƒ½é‡ç­‰ï¼‰
   1. å‘å¸ƒä»»åŠ¡ï¼Œç›¸å½“äºé”å®šäº†è¿™éƒ¨åˆ†èµ„æº
   2. ä¸­æ­¢ï¼Œå®Œæˆä»»åŠ¡åï¼Œéœ€è¦é‡Šæ”¾è¿™éƒ¨åˆ†èµ„æº
5. ä»»åŠ¡å¯èƒ½ä¼šæ¶‰åŠåˆ°å¤æ•°çš„èµ„æºï¼Œå¯¹è¿™äº›èµ„æºçš„æ“ä½œï¼Œå¯èƒ½åŒæ—¶è¿›è¡Œï¼Œä¹Ÿå¯èƒ½æŒ‰é¡ºåºè¿›è¡Œ

é’ˆå¯¹1ï¼Œ2ï¼Œ3ï¼Œ5ç‰¹å¾ï¼Œä¸ºäº†è®©ä»»åŠ¡çš„ä¹¦å†™æ›´ä¾¿åˆ©ï¼Œç¬”è€…è®¾è®¡å¹¶å®ç°äº†ä¸€å¥—å¼‚æ­¥æ‰§è¡Œæ¡†æ¶ã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œç¬”è€…å°†ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ¡†æ¶ï¼Œä»¥åŠè¯¥æ¡†æ¶æ˜¯å¦‚ä½•å®ç°çš„ã€‚

**ç¬¬å››ç‚¹ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­è¯¦ç»†è¯´æ˜ï¼Œæ•¬è¯·æœŸå¾…ã€‚**



## å¼‚æ­¥æ‰§è¡Œæ¡†æ¶

å¯¹å®ç°ç»†èŠ‚ä¸æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è·³è‡³æœ€åä¸€èŠ‚â€œç¼–å†™è‡ªå®šä¹‰ä»»åŠ¡â€

### æ¦‚è§ˆ

![ä»»åŠ¡ç»“æ„ç¤ºæ„.jpg](https://upload-images.jianshu.io/upload_images/26257383-9d28b03b9ea4ef64.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


![ä»»åŠ¡æ‰§è¡Œç¤ºæ„.jpg](https://upload-images.jianshu.io/upload_images/26257383-7104ef6e27ca089a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


è¯­æ³•è®¾è®¡ç±»ä¼¼äºC#çš„[Task](https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.tasks.task?view=net-5.0)ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥äº†è§£ä¸‹ï¼Œåœ¨è®¾è®¡è¿‡ç¨‹ä¸­åšäº†å¾ˆå¤šç®€åŒ–å’Œå¦¥åã€‚

### ä»»åŠ¡ TaskEntity

ä»»åŠ¡åŒ…å«äº†

1. ä¸€ç³»åˆ—æŒ‡ä»¤ç»„ï¼ˆæ­¥éª¤ï¼‰
2. å½“æœŸæ‰§è¡Œçš„æ­¥éª¤
3. æ¯ä¸ªæŒ‡ä»¤ç»„çš„æ‰§è¡Œæ–¹å¼ï¼šWaitAllï¼ˆæŒ‡ä»¤ç»„ä¸­çš„æŒ‡ä»¤å…¨éƒ¨å®Œæˆï¼Œè§†ä½œè¯¥æŒ‡ä»¤ç»„æ‰§è¡Œå®Œæˆï¼‰, WaitAnyï¼ˆæŒ‡ä»¤ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªæŒ‡ä»¤å…¨éƒ¨å®Œæˆï¼Œè§†ä½œè¯¥æŒ‡ä»¤ç»„æ‰§è¡Œå®Œæˆï¼‰

```typescript
interface ActionGroup {
	waitType: "all" | "any"
	actionsIds: string[]
}

type TaskStatus = "running" | "complete" | "fail"

interface TaskEntity extends Entity {
	status: TaskStatus
	step: number
	actionsGroups:ActionGroup[]
}
```

æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼šä¾æ¬¡æ‰§è¡Œæ¯ä¸ªæŒ‡ä»¤ç»„ï¼ˆæ­¥éª¤ï¼‰ï¼Œæ ¹æ®æŒ‡ä»¤ç»„çš„æ¨¡å¼ï¼Œä»¥åŠæŒ‡ä»¤ç»„ä¸‹æ¯ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œæƒ…å†µï¼Œå†³å®šæŒ‡ä»¤ç»„ä»€ä¹ˆå®Œæˆï¼Œå¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªæŒ‡ä»¤ç»„ã€‚

### æŒ‡ä»¤ ActionEntity

æŒ‡ä»¤åŒ…å«äº†

1. æ“ä½œè€…çš„id (æ¯”å¦‚ï¼šCreep çš„ id)
2. ä¸€ä¸ªåŒæ­¥æ–¹æ³•çš„ç±»å‹
3. åºåˆ—åŒ–åçš„å‚æ•°

```typescript
interface ActionEntity extends Entity {
	operatorId: string
	type: string
	parameters: any[]
}
```

æ‰§è¡ŒæŒ‡ä»¤æ—¶ï¼Œä¼šé€šè¿‡ç±»å‹æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œå¹¶è¿›è¡Œè°ƒç”¨

### åŒæ­¥æ–¹æ³•ï¼ˆæœ«å°¾ä¸å¸¦Asyncçš„æ–¹æ³•ï¼‰

è¿™ç±»æ–¹æ³•ï¼Œå¯¹æ¸¸æˆAPIè¿›è¡Œäº†å°è£…ï¼Œä¸”åªèƒ½è¿”å› running, complete, fail ä¸‰ç§çŠ¶æ€å€¼ã€‚
running æ„å‘³ç€è¯¥æ–¹æ³•ä¸‹tickè¿˜éœ€è¦ç»§ç»­æ‰§è¡Œã€‚

```typescript
Creep.prototype.reach = function (target, range = 1) {
    if (!target || !this) return "fail";
    const pos: RoomPosition = Convert.ToRoomPosition(target);
    if (this.pos.getRangeTo(pos) > range) {
        this.moveTo(target);
        return "running";
    } else {
        return "complete";
    }
};
```

### å¼‚æ­¥æ–¹æ³•ï¼ˆæœ«å°¾å¸¦Aysncçš„æ–¹æ³•ï¼‰

æ¯ä¸ªåŒæ­¥æ–¹æ³•ï¼Œéƒ½å¯¹åº”ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œä¸”å…¥å‚å®Œå…¨ä¸€è‡´ã€‚

å¼‚æ­¥æ–¹æ³•çš„ä½œç”¨æ˜¯ï¼Œå°†å…¥å‚åºåˆ—åŒ–ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡ä»¤ã€‚

```typescript
Creep.prototype.reachAsync = function (target, range = 1) {
    const posEntity = Convert.ToPosEntity(target);
    const reachAction = ActionContext.CreateAndAdd(this.id, _this.type, [posEntity, range]);
    return reachAction;
};
```

### ä»»åŠ¡ç±» Task

ä»»åŠ¡ç±»æ˜¯ä¹¦å†™è‡ªå®šä¹‰ä»»åŠ¡æ—¶ä½¿ç”¨çš„å·¥å…·ç±»ï¼Œé€šè¿‡è°ƒç”¨Wait(), WaitAny(), WaitAll() æ–¹æ³•ï¼Œæ¥ç»´æŠ¤ä»»åŠ¡ä¸­çš„æŒ‡ä»¤ç»„ã€‚

```typescript
class Task {
	public _task: TaskEntity;

	constructor() {
		this._task = TaskContext.CreateAndAdd();
	}
	Wait(actionEntity: ActionEntity) {
		this.WaitAll(actionEntity);
	}
	/**
	 * æœ‰ä¸€ä¸ªæ‰§è¡ŒæˆåŠŸå°±ç®—æˆåŠŸï¼Œå¤±è´¥ä¼šç«‹å³é˜»æ–­ã€‚
	 * @param  {ActionEntity[]} ...actionEntities
	 */
	WaitAny(...actionEntities: ActionEntity[]) {
		const actionIds = _.map(actionEntities, (entity) => entity.id);
		this._task.actionsGroups.push({
			waitType: "any",
			actionsIds: actionIds
		})
		TaskContext.Update(this._task);
	}
	/**
	 * å…¨éƒ¨æ‰§è¡ŒæˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¤±è´¥ä¼šç«‹å³é˜»æ–­ã€‚
	 * @param  {ActionEntity[]} ...actionEntities
	 */
	WaitAll(...actionEntities: ActionEntity[]) {
		const actionIds = _.map(actionEntities, (entity) => entity.id);
		this._task.actionsGroups.push({
			waitType: "all",
			actionsIds: actionIds
		})
		TaskContext.Update(this._task);
	}
}
```



### æŒ‡ä»¤ç±» Action

æŒ‡ä»¤ç±»ä¸­ï¼Œå¯¹åŒæ­¥æ–¹æ³•ï¼Œå¼‚æ­¥æ–¹æ³•è¿›è¡ŒæŒ‚è½½ï¼Œå¹¶åŒ…å«äº†è¯¥æŒ‡ä»¤æ‰§è¡Œçš„é€»è¾‘ï¼ˆä¸»è¦æ˜¯å‚æ•°çš„ååºåˆ—åŒ–ï¼‰ã€‚

```typescript
type ActionStatus = "running" | "complete" | "fail"

interface Action {
	type:string
	// å°†åŒæ­¥æ–¹æ³•ï¼Œå¼‚æ­¥æ–¹æ³•æŒ‚è½½åˆ°prototypeä¸Š
	mount(): void
	// æ‰§è¡Œç»™å®šçš„æŒ‡ä»¤
	run(actionEntity:ActionEntity): ActionStatus
}
```

## ç¼–å†™è‡ªå®šä¹‰ä»»åŠ¡çš„ä¾‹å­

### ç‚¹å¯¹ç‚¹è¿è¾“

```typescript
export function One2OneTransferTask(creep: Creep, resourceType: ResourceConstant, fromStructure: Structure | Tombstone | Ruin, toStructure: Structure, amount?: number) {
	const task = new Task();
	task.Wait(creep.reachAsync(fromStructure));
	task.Wait(creep.withdrawOnceAsync(fromStructure, resourceType, amount));
	task.Wait(creep.reachAsync(toStructure));
	task.Wait(creep.transferOnceAsync(toStructure, resourceType, amount));
}
```

![ç‚¹å¯¹ç‚¹è¿è¾“.gif](https://upload-images.jianshu.io/upload_images/26257383-e3f500ae155fe54c.gif?imageMogr2/auto-orient/strip)


### æ‰¹é‡å¡«å……

```typescript
export function DistributeTask(creep: Creep, resourceType: ResourceConstant, fromStructure: Structure | Tombstone | Ruin, toStructures: Structure[], totalAmount?: number) {
	const task = new Task();
	task.Wait(creep.reachAsync(fromStructure));
	task.Wait(creep.withdrawOnceAsync(fromStructure, resourceType, totalAmount));
	_.map(toStructures, (toStructure) => {
		task.Wait(creep.reachAsync(toStructure));
		task.Wait(creep.transferOnceAsync(toStructure, resourceType));
	})
}
```

![å¡«å…….gif](https://upload-images.jianshu.io/upload_images/26257383-383e6a463aa52f6d.gif?imageMogr2/auto-orient/strip)


### è®¾ç½®ä»»åŠ¡è¶…æ—¶ï¼ˆå¼€å‘ä¸­ï¼Œä»…ä½œå‚è€ƒï¼‰

```typescript
function TimeOutTestTask(creep: Creep, pos: RoomPosition) {
	const task = new Task();
	const promise1 = creep.reachAsync(pos);
	const promise2 = TimeOutAction.TimeOut(1500);
	task.WaitAny(promise1, promise2);
}
```

### ç»™èµ„æºåŠ é”ï¼ˆå¼€å‘ä¸­ï¼Œä»…ä¾›å‚è€ƒï¼‰

```typescript
export function One2OneTransferLockTask(creep: Creep, resourceType: ResourceConstant, fromStructure: Structure | Tombstone | Ruin, toStructure: Structure, amount?: number) {
	const task = new Task();
	task.LockCreep(creep);
	task.LockResources("out", fromStructure, amount);
	task.LockResources("in", toStructure, amount);
	task.Wait(creep.reachAsync(fromStructure));
	task.Wait(creep.withdrawOnceAsync(fromStructure, resourceType, amount));
	task.Wait(creep.reachAsync(toStructure));
	task.Wait(creep.transferOnceAsync(toStructure, resourceType, amount));
	// ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œä»»åŠ¡å®Œæˆ/å¤±è´¥/ä¸­æ­¢æ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æº
}
```

### å¤šå¯¹è±¡åŒæ­¥æ“ä½œ

```typescript
export function SpiralMoveTask(center:RoomPosition, edgeLength: number, creep1: Creep, creep2: Creep, creep3: Creep, creep4: Creep) {
	const task = new Task();
	const diffX = edgeLength / 2;
	const diffY = edgeLength / 2;
	const leftTopPos = new RoomPosition(center.x - diffX, center.y - diffY, center.roomName);
	const rightTopPos = new RoomPosition(center.x + diffX, center.y - diffY, center.roomName);
	const leftBottomPos = new RoomPosition(center.x - diffX, center.y + diffY, center.roomName);
	const rightBottomPos = new RoomPosition(center.x + diffX, center.y + diffY, center.roomName);
	const p1 = creep1.reachAsync(leftTopPos, 0);
	const p2 = creep2.reachAsync(rightTopPos, 0);
	const p3 = creep3.reachAsync(leftBottomPos, 0);
	const p4 = creep4.reachAsync(rightBottomPos, 0);
	task.WaitAll(p1, p2, p3, p4);
	const p5 = creep1.trackAsync(creep3);
	const p6 = creep2.trackAsync(creep1);
	const p7 = creep4.trackAsync(creep2);
	const p8 = creep3.trackAsync(creep4);
	task.WaitAll(p5, p6, p7, p8);
}
```

![èºæ—‹.gif](https://upload-images.jianshu.io/upload_images/26257383-a8f7642902e9415f.gif?imageMogr2/auto-orient/strip)


## åç»­å¼€å‘è®¡åˆ’

1. ä»»åŠ¡åˆ¶ç›¸å…³çš„èµ„æºé”
2. è¶…æ—¶é”
3. ç›®å‰å¼‚æ­¥æ–¹æ³•ç›¸å½“äºè¿”å›voidï¼Œåç»­å°è¯•å…è®¸è¿”å›å€¼ï¼Œåç»­æŒ‡ä»¤å¯ä»¥ç”¨å‰é¢æŒ‡ä»¤çš„æ‰§è¡Œç»“æœä½œä¸ºå…¥å‚
